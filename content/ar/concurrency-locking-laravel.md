# التزامن والأقفال في قواعد البيانات باستخدام Laravel

## لماذا التزامن مهم؟
عندما تصل عدة طلبات لنفس البيانات في نفس الوقت قد تحدث مشاكل مثل تكرار الدفع أو ضياع تحديثات. التحكم في التزامن يحافظ على سلامة البيانات.

## مشاكل شائعة
- ضياع التحديثات: تحديثان على نفس السجل ويتفوق أحدهما على الآخر.
- قراءة بيانات غير معتمدة.
- نتائج غير ثابتة داخل نفس العملية.

## أدوات Laravel للتزامن

### 1) المعاملات Transactions
تنفيذ العمليات كوحدة واحدة.

```php
DB::transaction(function () {
    // read
    // write
});
```

### 2) الأقفال المتشائمة (For Update)
قفل الصفوف أثناء التحديث.

```php
DB::transaction(function () {
    $wallet = DB::table('wallets')
        ->where('id', $id)
        ->lockForUpdate()
        ->first();

    // update safely
});
```

### 3) الأقفال المشتركة
قراءة مسموحة مع منع الكتابة.

```php
DB::transaction(function () {
    $report = DB::table('reports')
        ->where('id', $id)
        ->sharedLock()
        ->first();
});
```

### 4) الأقفال المتفائلة (يدويًا)
إضافة عمود `version` والتحقق منه قبل التحديث.

```php
$updated = DB::table('orders')
    ->where('id', $id)
    ->where('version', $version)
    ->update([
        'status' => 'paid',
        'version' => $version + 1,
    ]);

if ($updated === 0) {
    // حدث تعديل آخر، أعد المحاولة
}
```

## نصائح عملية
- أي تحديثات مالية يجب أن تكون داخل transaction.
- استخدم `lockForUpdate()` عندما تحتاج كاتبًا واحدًا فقط.
- اجعل المعاملات قصيرة لتجنب الأقفال الطويلة.

## الخلاصة
التزامن ضروري في الإنتاج. Laravel يوفر معاملات وأقفال على مستوى الصفوف. استخدمها لضمان سلامة البيانات.
